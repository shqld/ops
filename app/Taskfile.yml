version: '3'

tasks:
    setup:
        cmds:
            - task: up

    up:
        sources:
            - /ops/app/docker-compose.yaml
        deps:
            - docker-login
        cmds:
            - docker-compose -f /ops/app/docker-compose.yaml up -d

    down:
        deps:
            - up
        cmds:
            - docker-compose -f /ops/app/docker-compose.yaml down

    restart:
        sources:
            - /ops/app/varnish/default.vcl
        deps:
            - docker-login
            - up
        cmds:
            - docker-compose -f /ops/app/docker-compose.yaml restart

    logs:
        deps:
            - up
        cmds:
            - docker-compose -f /ops/app/docker-compose.yaml logs

    docker-login:
        silent: true
        status:
            - grep -q 'ghcr.io' < "$HOME/.docker/config.json"
        cmds:
            - test -f "${DOCKER_REGISTRY_TOKEN}"
            - echo "${DOCKER_REGISTRY_TOKEN}" | docker login -u shqld --password-stdin ghcr.io
