version: '3.8'
services:
    gateway:
        image: cdrocker/nginx:latest
        ports:
            - '8443:443/tcp'
            - '8443:443/udp'
        networks:
            - gateway
        volumes:
            - /ops/app/gateway/nginx.conf:/etc/nginx/nginx.conf
            - /etc/letsencrypt:/etc/letsencrypt
        user: '${CONTAINER_UID}'
        deploy:
            replicas: 1

    varnish:
        image: varnish:fresh-alpine
        networks:
            - gateway
            - varnish
        volumes:
            - /ops/app/varnish/default.vcl:/etc/varnish/default.vcl
            - /ops/app/varnish/config:/etc/sysconfig/varnish

    www:
        image: ghcr.io/shqld/dev/web:latest
        networks:
            - varnish
        user: '${CONTAINER_UID}'
        environment:
            - 'PORT=3000'
            - 'HOST=varnish'
        depends_on:
            - varnish
        deploy:
            replicas: 1

networks:
    gateway:
    varnish:

        # update_config:
        #     parallelism: 2
        #     order: start-first
        #     failure_action: rollback
        # rollback_config:
        #     parallelism: 0
        #     order: stop-first
        # restart_policy:
        #     condition: any
        #     max_attempts: 3
        #     window: 120s
